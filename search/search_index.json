{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Home","text":""},{"location":"#updates2mqtt","title":"updates2mqtt","text":""},{"location":"#summary","title":"Summary","text":"<p>Let Home Assistant tell you about new updates to Docker images for your containers.</p> <p> </p> <p>Read the release notes, and optionally click Update to trigger a Docker pull (or optionally build) and update.</p> <p></p>"},{"location":"#description","title":"Description","text":"<p>Updates2MQTT perioidically checks for new versions of components being available, and publishes new version info to MQTT. HomeAssistant auto discovery is supported, so all updates can be seen in the same place as Home Assistant\u2019s own components and add-ins.</p> <p>Currently only Docker containers are supported, either via an image registry check (using either v1 Docker APIs or the OCI v2 API), or a git repo for source (see Local Builds), with specific handling for Docker, Github Container Registry, Gitlab, Codeberg, Microsoft Container Registry, Quay and LinuxServer Registry, with adaptive behaviour to cope with most others.  The design is modular, so other update sources can be added, at least for notification. The next anticipated is apt for Debian based systems.</p> <p>Components can also be updated, either automatically or triggered via MQTT, for example by hitting the Install button in the HomeAssistant update dialog. Icons and release notes can be specified for a better HA experience. See Home Assistant Integration for details.</p> <p>To get started, read the Installation and Configuration pages.</p> <p>For a quick spin, try this:</p> <pre><code>docker run -v /var/run/docker.sock:/var/run/docker.sock -e MQTT_USER=user1 -e MQTT_PASS=user1 -e MQTT_HOST=192.168.1.5 ghcr.io/rhizomatics/updates2mqtt:latest\n</code></pre> <p>or without Docker, using uv</p> <pre><code>export MQTT_HOST=192.168.1.1;export MQTT_USER=user1;export MQTT_PASS=user1;uv run --with updates2mqtt python -m updates2mqtt\n</code></pre> <p>It also comes with a basic command line tool that will perform the analysis for a single running container, or fetch manifests, JSON blobs and lists of tags from remote registries (known to work with GitHub, GitLab, Codeberg, Quay, LSCR and Microsoft MCR).</p>"},{"location":"#release-support","title":"Release Support","text":"<p>Presently only Docker containers are supported, although others are planned, probably with priority for <code>apt</code>.</p> Ecosystem Support Comments Docker Scan. Fetch Fetch is <code>docker pull</code> only. Restart support only for <code>docker-compose</code> image based containers."},{"location":"#heartbeat","title":"Heartbeat","text":"<p>A heartbeat JSON payload is optionally published periodically to a configurable MQTT topic, defaulting to <code>healthcheck/{node_name}/updates2mqtt</code>. It contains the current version of Updates2MQTT, the node name, a timestamp, and some basic stats.</p>"},{"location":"#healthcheck","title":"Healthcheck","text":"<p>A <code>healthcheck.sh</code> script is included in the Docker image, and can be used as a Docker healthcheck, if the container environment variables are set for <code>MQTT_HOST</code>, <code>MQTT_PORT</code>, <code>MQTT_USER</code> and <code>MQTT_PASS</code>. It uses the <code>mosquitto-clients</code> Linux package which provides <code>mosquitto_sub</code> command to subscribe to topics.</p> <p>Tip</p> <p>Check healthcheck is working using <code>docker inspect --format \"{{json .State.Health }}\" updates2mqtt | jq</code> (can omit <code>| jq</code> if you don\u2019t have jsonquery installed, but much easier to read with it)</p> <p>Another approach is using a restarter service directly in Docker Compose to force a restart, in this case once a day:</p> Example Compose Service<pre><code>restarter:\n    image: docker:cli\n    volumes: [\"/var/run/docker.sock:/var/run/docker.sock\"]\n    command: [\"/bin/sh\", \"-c\", \"while true; do sleep 86400; docker restart updates2mqtt; done\"]\n    restart: unless-stopped\n    environment:\n      - UPD2MQTT_UPDATE=AUTO\n</code></pre>"},{"location":"#target-containers","title":"Target Containers","text":"<p>While <code>updates2mqtt</code> will discover and monitor all containers running under the Docker daemon, there are some options to make to those containers to tune how it works.</p> <p>These happen by adding environment variables or docker labels to the containers, typically inside an <code>.env</code> file, or as <code>environment</code> options inside <code>docker-compose.yaml</code>.</p>"},{"location":"#automated-updates","title":"Automated updates","text":"<p>If Docker containers should be immediately updated, without any confirmation or trigger, e.g. from the HomeAssistant update dialog, then set an environment variable <code>UPD2MQTT_UPDATE</code> in the target container to <code>Auto</code> ( it defaults to <code>Passive</code>).  If you want it to update without publishing to MQTT and being visible to Home Assistant, then use <code>Silent</code>.</p> Example Compose Snippet<pre><code>restarter:\n    image: docker:cli\n    command: [\"/bin/sh\", \"-c\", \"while true; do sleep 86400; docker restart mailserver; done\"]\n    environment:\n      - UPD2MQTT_UPDATE=AUTO\n</code></pre> <p>Automated updates can also apply to local builds, where a <code>git_repo_path</code> has been defined - if there are remote commits available to pull, then a <code>git pull</code>, <code>docker compose build</code> and <code>docker compose up</code> will be executed.</p>"},{"location":"#related-projects","title":"Related Projects","text":"<p>Other apps useful for self-hosting with the help of MQTT:</p> <ul> <li>psmqtt - Report system health and metrics via MQTT</li> </ul> <p>Find more at awesome-mqtt</p> <p>For a more powerful Docker focussed update manager, try What\u2019s Up Docker</p>"},{"location":"#development","title":"Development","text":"<p>This component relies on several open source packages:</p> <ul> <li>docker-py SDK for Python for access to Docker APIs</li> <li>Eclipse Paho MQTT client</li> <li>OmegaConf for configuration and validation</li> <li>structlog for structured logging and rich for better exception reporting</li> <li>hishel for caching metadata</li> <li>httpx for retrieving metadata</li> <li>The Astral uv and ruff tools for development and build</li> <li>pytest and supporting add-ins for automated testing</li> <li>usingversion to log current version info</li> </ul>"},{"location":"changelog/","title":"CHANGELOG","text":""},{"location":"changelog/#185","title":"1.8.5","text":"<ul> <li>Initial clean of MQTT topic on startup to remove any hanging in-progress status</li> <li>Default max summary size now 6K</li> <li>Truncation now logged</li> </ul>"},{"location":"changelog/#184","title":"1.8.4","text":""},{"location":"changelog/#release-info","title":"Release Info","text":"<ul> <li>Default max summary size now 8K, to avoid Home Assistant warnings on state</li> <li>This limit can be increased, or removed, if the Update entities are excluded from Home Assistant\u2019s state history</li> </ul>"},{"location":"changelog/#183","title":"1.8.3","text":""},{"location":"changelog/#release-info_1","title":"Release Info","text":"<ul> <li>Release summaries can now have a max length, using <code>release_summary_max_size</code>, default 16k</li> </ul>"},{"location":"changelog/#182","title":"1.8.2","text":""},{"location":"changelog/#version-detection","title":"Version Detection","text":"<ul> <li>Tighten up auto and fallback rules for cases where digests don\u2019t match</li> <li>Use versions in tag where they are SemVer or casual versions</li> </ul>"},{"location":"changelog/#cli","title":"CLI","text":"<ul> <li>Added <code>dump=csv</code>, <code>dump=json</code> and <code>help</code> commands</li> </ul>"},{"location":"changelog/#common-packages","title":"Common Packages","text":"<ul> <li>Added EMQX, Mosquitto, Plex, Emby, Tailscale, AppWrite, Traefik, Grafana, Prometheus, WhatsUpDocker, Lychee and HomeAssistant</li> </ul>"},{"location":"changelog/#181","title":"1.8.1","text":""},{"location":"changelog/#home-assistant","title":"Home Assistant","text":"<ul> <li>Re-publish state every scan to ensure fresh</li> <li>Main discovery and state message now better in sync on <code>in_progress</code> flag</li> <li>State not published during update if Home Assistant mode off</li> </ul>"},{"location":"changelog/#version-detection_1","title":"Version Detection","text":"<ul> <li>Version Policy now includes <code>TIMESTAMP</code> for image creation date/time, which is also now part of auto version algorithm</li> <li>Version policy can be also be set in <code>custom_packages.yaml</code> or in the <code>packages</code> section of config</li> <li>Detect common mis-configuration where ubuntu base layer version published as derived image version</li> </ul>"},{"location":"changelog/#mqtt","title":"MQTT","text":"<ul> <li>MQTT result code, MID and publish status logged at debug, and at warning if non-success result code</li> </ul>"},{"location":"changelog/#180","title":"1.8.0","text":""},{"location":"changelog/#package-info","title":"Package Info","text":"<ul> <li>The <code>common_packages.yaml</code> that ships inside the Docker image can be extended, or overridden, using the <code>packages</code> section of the main config file</li> <li>Source platform will be inferred, and verified, for GitHub, Gitlab, Quay, LSCR and Codeberg</li> </ul>"},{"location":"changelog/#release-notes","title":"Release Notes","text":"<ul> <li>If the component tag doesn\u2019t match the release tag (e.g. <code>1.7.3</code> vs <code>v1.7.3</code>), an alt lookup will be made on latest github released, and used if the tag name on that release matches the expected tag, with a common <code>v</code>,<code>V</code>,<code>r</code> or <code>R</code> prefix</li> <li>A GitHub personal access token can now be added in the <code>github:</code> config section, which will increase number of API calls that can be made for release info before being throttled</li> <li>Release notes can be better guessed, subject to URL validation, for Gitlab and GitHub</li> </ul>"},{"location":"changelog/#cli_1","title":"CLI","text":"<ul> <li>Logging improved, with different default for container lookup, so there\u2019s always some output from commands</li> <li>Added a <code>tags</code> option to retrieve list of known tags in the registry</li> </ul>"},{"location":"changelog/#housekeeping","title":"Housekeeping","text":"<ul> <li>MQTT topic clean overhauled - <ul> <li>Now runs only after scan</li> <li>Checks topics against current discoveries vs previous session key based check</li> </ul> </li> </ul>"},{"location":"changelog/#173","title":"1.7.3","text":"<ul> <li>Minor fix for stats reporting</li> </ul>"},{"location":"changelog/#172","title":"1.7.2","text":""},{"location":"changelog/#api-stats","title":"API Stats","text":"<ul> <li>OCI v2 API client maintains api stats per host, and errors per status code, with a cache hit ratio and avg elapsed time</li> </ul>"},{"location":"changelog/#container-registry-checks","title":"Container Registry Checks","text":"<ul> <li>The Config document is now also pulled in, which means more images have annotations, nice versions and release notes</li> <li><code>OCI_V2_MINIMAL</code> option to make only the calls needed for version checks</li> <li>Diagnostic code now distinguishes two ways that different digests are checked between old and new</li> <li>Stats now tallied for all registry URL calls, and periodically logged</li> </ul>"},{"location":"changelog/#cli_2","title":"CLI","text":"<ul> <li>Fixed issues with docker.io fetches</li> <li>Colourful and jq friendly JSON output</li> <li>Log level now defaults to WARNING to make it easier to pipe results to <code>jq</code>, can change to see headers using <code>log_level=DEBUG</code></li> </ul>"},{"location":"changelog/#171","title":"1.7.1","text":"<ul> <li>No code change, version changed to fix a pypi publish issue</li> </ul>"},{"location":"changelog/#170","title":"1.7.0","text":""},{"location":"changelog/#py314","title":"py3.14","text":"<ul> <li>Image now built with python 3.14 by default</li> <li>Tests update for py3.14 mock async changes</li> </ul>"},{"location":"changelog/#oci-container-registry-apis","title":"OCI Container Registry APIs","text":"<ul> <li>By default now uses the OCI v2 Distribution APIs rather than old Docker APIs via Docker SDK</li> <li>Older method can be switched back on using <code>docker.registry.api: docker_client</code> configuration</li> <li>Container registry also used where available to pull in annotations ( including  a meaningful version ) using the OCI Distriubtion API</li> <li>Docker, GitHub GHCR, Gitlab, LSCR, Microsoft MCR and Codeberg configured</li> <li>Authentication logic to automatically adapt and retry dynamically for other platforms</li> <li>Annotations will be sourced from the Index or Manifest, with priority for the (platform-specific) manifest</li> <li>Digest matching adapts to different practices across repos</li> <li>Registries can now be selectively included/excluded using <code>registry_select</code> in Docker configuration section</li> </ul>"},{"location":"changelog/#github-release-enrichment","title":"GitHub Release Enrichment","text":"<ul> <li>Where an annotation points to a source URL and hash, this can be used to derive a  <code>diff_url</code>, a direct link to the actual release notes, and a release summary pulled from the Github source repo releases and passed onto Home Assistant</li> <li>A token can be provided, e.g. a Personal Access Token, at container level using <code>UPD2MQTT_REGISTRY_TOKEN</code></li> <li>Common packages now have a <code>source_repo_url</code> and don\u2019t need a release notes URL too if on GitHub</li> </ul>"},{"location":"changelog/#version-policies","title":"Version Policies","text":"<ul> <li>Version policies available to make use of meaningful versions from annotations</li> <li><code>AUTO</code> will detect what looks like a SemVer and report only the meaningful version to HA</li> <li><code>VERSION</code>,<code>DIGEST</code> and <code>VERSION_DIGEST</code> can be used to fix on which fields to use</li> <li>If the chosen option isn\u2019t available, next preference is for <code>version:digest</code> qualified version, falling back to whatever else is available</li> <li>Version policy can be set at container level using <code>UPD2MQTT_VERSION_POLICY</code> env var or corresponding label</li> <li>Version selection now has a diagnostic code, <code>version_basis</code>, that ties back to precisely which code used</li> </ul>"},{"location":"changelog/#local-docker-image-enrichment","title":"Local Docker Image Enrichment","text":"<ul> <li>Metadata from local <code>org.opencontainers</code> labels published where available</li> <li>Added more packages to common-packages, vector and greptime</li> </ul>"},{"location":"changelog/#selective-home-assistant-discovery","title":"Selective Home Assistant Discovery","text":"<ul> <li>New <code>version_select</code> option in Docker config works like <code>image_ref_select</code> using the reported version instead</li> </ul>"},{"location":"changelog/#pinned-digests","title":"Pinned Digests","text":"<ul> <li>Better handling of tags with a pinned digest, e.g. <code>ghcr.io/immich-app/postgres:14-vectorchord0.4.3-pgvectors0.2.0@sha256:41eacbe83eca995561fe43814fd4891e16e39632806253848efaf04d3c8a8b84</code></li> </ul>"},{"location":"changelog/#api-throttling","title":"API Throttling","text":"<ul> <li>Throttling fixed for TTL taken from remote API</li> <li>Docker provider shuffles the list of containers it scans so if there is aggressive throttling there isn\u2019t the same set of containers always getting scanned before the rate limit hits</li> </ul>"},{"location":"changelog/#caching","title":"Caching","text":"<ul> <li>Index and Manifest local cache age now reported on MQTT message</li> <li>Additional logging and defaults for caching</li> <li>Local cache TTL override can be removed by using <code>None</code> for cache_ttl in registry config</li> </ul>"},{"location":"changelog/#160","title":"1.6.0","text":""},{"location":"changelog/#mqtt-topics","title":"MQTT Topics","text":"<ul> <li>Separated out generic and Home Assistant specific topics</li> <li>The State, Command and Discovery topics are strictly Home Assistant schema</li> <li>The full discovery attributes are now published on their own topic<ul> <li>This can also be supplied as additional attributes to the Home Assistant Update entity</li> <li>These can be turned off using the <code>extra_attributes</code> flag in <code>homeassistant</code> config</li> </ul> </li> </ul>"},{"location":"changelog/#selective-home-assistant-discovery_1","title":"Selective Home Assistant Discovery","text":"<ul> <li>New <code>image_ref_select</code> option in Docker config<ul> <li>List of <code>include</code> strings or regular expressions, containers which don\u2019t match these won\u2019t be Home Assistant discoverable</li> <li>List of <code>exclude</code> strings or regular expressions, containers which match these won\u2019t be Home Assistant discoverable</li> <li>Containers not selected because of <code>image_ref_select</code> can still have an <code>Auto</code> update policy, so will be updated but not visible to Home Assistant</li> </ul> </li> </ul>"},{"location":"changelog/#docker-labels","title":"Docker Labels","text":"<ul> <li>Container customization can now be made by Docker labels instead of, or in addition to, env vars</li> </ul>"},{"location":"changelog/#api-throttling_1","title":"API Throttling","text":"<ul> <li>Docker API now throttled per registry if receives 429 Too Many Requests<ul> <li>Uses <code>retry_after</code> header value, if missing or unreadable defaults to configurable <code>default_api_backoff</code></li> </ul> </li> </ul>"},{"location":"changelog/#local-builds","title":"Local Builds","text":"<ul> <li>General overhaul of some issues and improvements for local git repo image builds</li> <li>Version now synthesized in place of image version<ul> <li><code>git:&lt;short sha&gt;</code> for current version</li> <li><code>git:&lt;short sha&gt;+&lt;commits behind&gt;</code> for latest version</li> </ul> </li> <li>Auto update policy restricted to when there\u2019s an update to build</li> <li>For local git repos, install available check made now at discovery time<ul> <li>Install update in HA only appears if there\u2019s a pull available</li> </ul> </li> </ul>"},{"location":"changelog/#internal","title":"Internal","text":"<ul> <li>Many more test cases added, focusing on Docker and MQTT integration</li> <li>Self-bounce now recognized and attempts to set exit code to 1, though container may still override that</li> </ul>"},{"location":"changelog/#152","title":"1.5.2","text":""},{"location":"changelog/#internal_1","title":"Internal","text":"<ul> <li>Build backend changed to <code>uv_build</code></li> <li>GitHub Actions workflows updated, including to new uv actions</li> </ul>"},{"location":"changelog/#151","title":"1.5.1","text":"<ul> <li><code>MQTT_VERSION</code> environment variable added, defaults to <code>3.11</code></li> <li><code>U2M_AUTOGEN_CONFIG</code> environment variable added to control auto-generation of config files and directories</li> <li><code>U2M_LOG_LEVEL</code> environment variable added to set log level without config file</li> <li>Title generation for Docker images reverts to same whether HA device set or not</li> <li>Test added to ensure component always functions without a config file, if no env var present</li> </ul>"},{"location":"changelog/#150","title":"1.5.0","text":"<ul> <li>Target specific service on docker compose commands, where available from <code>com.docker.compose.service</code> label</li> <li>Log level in config is now an enum, and forced to be upper case</li> <li>Removed unnecessary latest_version fields from config message, which also saves a redundant MQTT subscription</li> <li>Publication of <code>command_topic</code> for each discovery can now be forced with <code>force_command_topic</code> option</li> <li>More common packages: docker:cli</li> <li>Common packages can now match on the image ref rather than base name, for example <code>docker:cli</code></li> <li>Reduced log noise in INFO and increased logging detail for DEBUG</li> <li>Common Packages now allow entries without all the values, initially <code>rtl_433</code> which lacks a logo</li> </ul>"},{"location":"changelog/#142","title":"1.4.2","text":"<ul> <li>Replace <code>origin</code> in config MQTT message with <code>device</code> for better HomeAssistant compatibility</li> <li>An <code>area</code> can be defined in the Home Assistant section of config and this will then be used as <code>suggested_area</code> for device</li> <li>Icon and release note info added for Owntone, Nextcloud, n8n, and Homarr</li> <li>More testcases</li> </ul>"},{"location":"changelog/#141","title":"1.4.1","text":"<ul> <li>More logging for Docker discovery on why Home Assistant doesn\u2019t show an update button</li> <li>More test cases</li> <li><code>MqttClient</code> is now <code>MqttPublisher</code> to avoid confusion with actual MQTT client</li> <li>Task cleanup now only interrupts explicit list of tasks - healthcheck and discovery tasks</li> </ul>"},{"location":"changelog/#140","title":"1.4.0","text":"<ul> <li>MQTT protocol can now be set, to one of <code>3.1</code>,<code>3.11</code> or <code>5</code></li> <li>Debug messages now provided for <code>on_subscribe</code> and <code>on_unsubscribe</code> callbacks</li> <li>Troubleshooting, installation, configuration docs updated, images optimized</li> </ul>"},{"location":"changelog/#137","title":"1.3.7","text":"<ul> <li>Improved initial setup when run without config or env vars for MQTT</li> <li>Minor test deps update and pyproject docs</li> </ul>"},{"location":"changelog/#136","title":"1.3.6","text":"<ul> <li>Changed exit code on graceful shutdown to 143</li> <li>App now exits if the MQTT username / password is not authorized</li> <li>Improved handling of env vars, default config now assumes MQTT_HOST etc unless overridden</li> <li>Will now run without a config if correct <code>MQTT_HOST</code>,<code>MQTT_USER</code>,<code>MQTT_PASS</code>,<code>MQTT_PORT</code> env vars set or match the defaults (<code>127.0.0.1:1883</code>)</li> <li>Deps update</li> </ul>"},{"location":"home_assistant/","title":"HomeAssistant Integration","text":"<p><code>updates2mqtt</code> represents each component being managed as a MQTT Update entity, and uses MQTT discovery so that HomeAssistant automatically picks up components discovered by Updates2MQTT with zero configuration on HomeAssistant itself. </p>","tags":["homeassistant","mqtt","hass"]},{"location":"home_assistant/#configuration","title":"Configuration","text":"<p>If Home Assistant is already running with MQTT, and the defaults haven\u2019t been changed, then <code>updates2mqtt</code> will likely work as is, so long as its publishing to the same broker.</p> <p>Any updates that have support for automated install will automatically show in the Home Assistant settings page if the MQTT Integration is installed and automatic discovery is not disabled.</p> <p></p> <p>The <code>homeassistant</code> default topic prefix matches the default Updates2MQTT config, if its changed in HomeAssistant, then the Updates2MQTT config must be changed to match.</p> <p></p>","tags":["homeassistant","mqtt","hass"]},{"location":"home_assistant/#device-creation","title":"Device Creation","text":"<p>A Home Assistant device will be created for each Updates2MQTT agent on each server, and Home Assistant will then group all the relevant entities together on this device page. Use <code>device_creation: false</code> in the  <code>homeassistant</code> config block if you want to switch off this behaviour, and <code>area</code> if you want to provide a <code>suggested_area</code> for the device.</p>","tags":["homeassistant","mqtt","hass"]},{"location":"home_assistant/#mqtt-topics","title":"MQTT Topics","text":"<p>There are 44 separate types of MQTT topic used for HomeAssisstant integration:</p> <ul> <li>Config to support auto discovery. <ul> <li>A topic is created per component, with a name like <code>homeassistant/update/dockernuc_docker_jellyfin/update/config</code>. </li> <li>This can be disabled in the config file, and the <code>homeassistant</code> topic prefix can also be configured.</li> <li>All the configs for a given server will share the same Device, which can also be given a suggested Area</li> </ul> </li> <li>State to report the current version and the latest version available<ul> <li>One topic per component, like <code>updates2mqtt/dockernuc/docker/jellyfin/state</code></li> <li>This has a very limited schema</li> </ul> </li> <li>Command to support triggering an update. <ul> <li>These will be created on the fly by HomeAssistant when an update is requested</li> <li>Updates2MQTT subscribes to pick up the changes, so you won\u2019t typically see these if browsing MQTT topics. </li> <li>Only one is needed per Updates2MQTT agent, with a name like <code>updates2mqtt/dockernuc/docker</code></li> </ul> </li> <li>JSON Attributes sources extra attributes from the main <code>updates2mqtt</code> discovery topic<ul> <li>Switch this behaviour off using <code>extra_attributes: false</code> flag in Updates2MQTT HomeAssistant config</li> </ul> </li> </ul> <p>If the package supports automated update, then Skip and Install buttons will appear on the Home Assistant interface, and the package can be remotely fetched and the component restarted.</p> <p>If it doesn\u2019t support automated update, the <code>command_topic</code> won\u2019t be published with the configuration message, unless <code>force_command_topic</code> is set to <code>true</code> in the <code>homeassistant</code> configuration section, this will force the Home Assistant app to show the update, but with a do-nothing Update button.</p>","tags":["homeassistant","mqtt","hass"]},{"location":"home_assistant/#verifying-it-works","title":"Verifying it Works","text":"<p>Rather than wait for a container to need an update, you can check right away that Home Assistant has recognized the containers as MQTT Update targets.</p> <p>From the Entities View, or the Developer Tools, filter the entities by <code>update.</code> If there are lots of other updates (HassOS apps, Zigbee device firmware etc), then pick one of the container names you know.</p> <p></p>","tags":["homeassistant","mqtt","hass"]},{"location":"home_assistant/#custom-config","title":"Custom config","text":"<p>None of this is necessary, all optional for tuning how it works with Home Assistant.</p> updates2mqtt config snippet<pre><code>homeassistant:\n  discovery:\n    prefix: homeassistant\n    enabled: true # if false then only plain MQTT publication made\n  state_topic_suffix: state\n  area: Server Room # suggested area for dynamically created device\n  device_creation: true # create a device per server and associate all the `update` entities with that device\n  force_command_topic: false # Publish a command topic even if the component can't be updated (can help with Home Assistant presentation)\n  extra_attributes: true # switch off all the extra attributes beyond the strict state schema\n</code></pre>","tags":["homeassistant","mqtt","hass"]},{"location":"home_assistant/#more-home-assistant-information","title":"More Home Assistant information","text":"<ul> <li>MQTT Integration<ul> <li>Includes setting up a MQTT broker, MQTT Discovery, and trouble-shooting</li> </ul> </li> <li>MQTT Update</li> <li>Update Integration</li> </ul>","tags":["homeassistant","mqtt","hass"]},{"location":"installation/","title":"Installation","text":""},{"location":"installation/#install","title":"Install","text":"<p>Updates2MQTT prefers to be run inside a Docker container, though can run standalone, for example scripted via cron or systemd.</p> <p>The only mandatory configuration is the MQTT broker host, user name and password, which can be set by environment variables, or the config file. The node name will be taken from the operating system if there\u2019s no config file. See Configuration for details.</p> <p>To check that it\u2019s working, have a look at Verifying it Works on Home Assistant.</p>"},{"location":"installation/#docker","title":"Docker","text":"<p>See <code>examples</code> directory for a working <code>docker-compose.yaml</code>.</p> <p>If you want to update and restart containers, then the file system paths to the location of the directory where the docker compose file lives must be available in the Updates2MQTT container. </p> docker compose snippet<pre><code>volumes:\n      # Must have config directory mapped\n      - ./conf:/app/conf\n      # Must have the Docker daemon socket mapped\n      - /var/run/docker.sock:/var/run/docker.sock\n      # This list of paths is only needed when containers are to be updated\n      # The paths here are completely dependent on where your docker-compose files live\n      #\u00a0and the internal/external paths must be exactly the same\n      - /my/container/home:/my/container/home\n      - /more/containers:/more/containers\n</code></pre> <p>The example <code>docker-compose.yaml</code> mounts <code>/my/container/home</code> for this purpose, so if your containers are in <code>/my/container/home/app1</code>, <code>/my/container/home/app2</code> etc, then Updates2MQTT will be able to find them in order to restart them. Map as many root paths as needed.</p>"},{"location":"installation/#ensuring-always-running","title":"Ensuring Always Running","text":"<p>Use cron to make sure the container is always up, this example will run once an hour, adapt the schedule and the location of <code>docker-compose.yaml</code> for your needs.</p> <pre><code>sudo crontab -e\n</code></pre> <pre><code>0 * * * * /usr/bin/docker compose -f /containers/updates2mqtt/docker-compose.yaml up -d --no-recreate\n</code></pre>"},{"location":"installation/#without-docker","title":"Without Docker","text":"<p>Updates2MQTT is published as a PyPI package on every release, so it can be used in any way you like - cron, systemd, your own Dockerfile, or whatever.</p>"},{"location":"installation/#run-without-installing-using-uv","title":"Run without installing using uv","text":"<pre><code>uv run --with updates2mqtt updates2mqtt\n</code></pre>"},{"location":"installation/#install-and-run-with-pip","title":"Install and run with pip","text":"<pre><code>pip install updates2mqtt\npython3 -m updates2mqtt\n</code></pre>"},{"location":"installation/#on-portainer","title":"On Portainer","text":"<p>Install an Updates2MQTT container on each Portainer host, this can be using a <code>docker-compose.yaml</code> file, or using the Portainer UI to define the image name and env vars ( no config file required ). Each of the containers will show up as a Docker Compose service as if Portainer even if it has been fully managed by Portainer without a manual <code>docker-compose.yaml</code> file.</p>"},{"location":"local_builds/","title":"Local Builds","text":""},{"location":"local_builds/#custom-docker-builds","title":"Custom docker builds","text":"<p>If the image is locally built from a checked out git repo, package update can be driven by the availability of git repo changes to pull rather than a new image on a Docker registry. This will both show where a change is available in Home Assistant ( or other MQTT client ), and allow an update to be triggered remotely. </p> <p>(People sometimes do this as a quick way of forking and changing a repo that doesn\u2019t quite work for them, or if the app is a development work in progress).</p> Example docker-compose.yaml snippet<pre><code>services:\n  mymailserver:\n    build: ./build/mymailserver\n    environment:\n      - UPD2MQTT_GIT_REPO_PATH=build/mymailserver\n    volumes:\n      - /home/containers/mymailserver/build:/home/containers/mymailserver/build\n</code></pre> <p>Declare the git path using the env var in <code>UPD2MQTT_GIT_REPO_PATH</code> in the docker container ( directly or via an <code>.env</code> file), or an equivalent label (see Docker Labels). The git repo at this path will be used as the source of timestamps, and an update command will carry out a <code>git pull</code> and <code>docker-compose build</code> rather than pulling an image.</p> <p>Note that the Updates2MQTT docker container needs access to this path declared in its volumes, and that has to be read/write if automated install required.</p> <p>Since there\u2019s no image digest, the current git revision will be used as the version, like <code>git:c2b12584a27f</code>, and when there are remote repo commits to pull, the new version will show how many commits ahead it is, for example <code>git:c2b12584a27f+5</code></p>"},{"location":"troubleshooting/","title":"Troubleshooting","text":"","tags":["docker","docker-compose","homeassistant","mqtt","paho"]},{"location":"troubleshooting/#general","title":"General","text":"<p>Things that need to work:</p> <ul> <li>Docker API access to list and inspect containers</li> <li>MQTT Publication of results</li> <li>Home Assistant discovering the Update entities on MQTT</li> <li>Home Assistant generating update notices in UI when there\u2019s a new version</li> <li>Command Topic message sent by Home Assistant when Update button clicked</li> <li>Docker Compose available from shell to make updates and restart</li> <li>Git command available in shell to check for local repo updates and pull</li> </ul>","tags":["docker","docker-compose","homeassistant","mqtt","paho"]},{"location":"troubleshooting/#updates2mqtt-logs","title":"Updates2MQTT Logs","text":"<p>If running under docker, and following the container naming guidance, then see the logs using:</p> <p><code>docker logs updates2mqtt</code></p> <p>or change to the directory where the <code>docker-compose.yaml</code> is installed and do <code>docker compose logs</code></p>","tags":["docker","docker-compose","homeassistant","mqtt","paho"]},{"location":"troubleshooting/#changing-log-level","title":"Changing Log Level","text":"<p>Update the <code>config.yaml</code> and change the log level to DEBUG, which will show much more diagnostic information.</p> conf/config.yaml<pre><code>log:\n  level: DEBUG\n</code></pre> <p>When you have everything working, its best to change the log level back, so your container isn\u2019t generating big logs.</p>","tags":["docker","docker-compose","homeassistant","mqtt","paho"]},{"location":"troubleshooting/#going-inside-container","title":"Going Inside Container","text":"<p>From the <code>docker-compose.yaml</code> directory, execute </p> <p><code>docker compose exec -it updates2mqtt bash</code></p> <p>(if you have an old Docker install, you may need to use <code>docker-compose</code> instead of <code>docker compose</code>)</p> <p>This will give you shell access inside the container, which is a good way of checking for path issues, permissio issues etc. For example, if you have compose directories in the <code>/containers</code> directory, you could <code>cd /containers</code> and validate that Updates2MQTT can see the other compose directories, <code>ls</code> the contents, and run <code>docker compose</code> or <code>git</code> actions there.</p>","tags":["docker","docker-compose","homeassistant","mqtt","paho"]},{"location":"troubleshooting/#mqtt","title":"MQTT","text":"<p>If the host, port, user and password for MQTT are incorrect then usually this will show in the logs, or use a MQTT client to verify that Updates2MQTT is successfully posting to topics ( and that HomeAssistant itself is publishing to the same broker OK).</p> <p>Updates2MQTT uses the Eclipse Paho Python Client for all MQTT interaction, using v2 of the callback API, and supports the older MQTT implementations as well as the newer v5 protocol. The Issues list might give you some clues for your situation. </p>","tags":["docker","docker-compose","homeassistant","mqtt","paho"]},{"location":"troubleshooting/#mqtt-clients","title":"MQTT Clients","text":"<p>Use a desktop MQTT app - MQTTX will let you subscribe to <code>#</code> and see everything on a broker, while MQTT Explorer automatically shows a tree structure of topics, and can run either as a desktop app, or as web app running on Docker.</p> <p>These tools will let you inspect messages, and also publish your own, so can create your own update message and see if it gets picked up by the Home Assistant app.</p> <p>Alternatively, use the debug option and logging of Mosquitto broker, or the built-in admin/debug UI of EMQX broker. Or the handy command line <code>mosquitto_sub</code> and <code>mosquitto_pub</code>, which are also used by the Updates2MQTT health check.</p>","tags":["docker","docker-compose","homeassistant","mqtt","paho"]},{"location":"troubleshooting/#home-assistant","title":"Home Assistant","text":"","tags":["docker","docker-compose","homeassistant","mqtt","paho"]},{"location":"troubleshooting/#checklist","title":"Checklist","text":"<p>(All of these can be checked and changed via the Home Assistant UI.)</p> <ul> <li>HA is configured with an MQTT integration</li> <li>MQTT broker host and port is the same on HA as Updates2MQTT<ul> <li>Updates2MQTT has been tested with Mosquitto and EMQX</li> </ul> </li> <li>Automatic Discovery is on</li> <li>The discovery prefix matches Updates2MQTT ( they both default to <code>homeassistant</code>)</li> </ul> <p>See the examples at Home Assistant Configuration</p> <p>In addition to the base MQTT configuration, Updates2MQTT relies on MQTT Discovery and MQTT Update integrations. All of these have a single set of MQTT Issues. </p> <p>When configured, each monitored container will have an <code>update</code> entity visible in the Home Assistant Developer Tools and Entities View.</p>","tags":["docker","docker-compose","homeassistant","mqtt","paho"]},{"location":"troubleshooting/#home-assistant-mosquitto-hassos-app","title":"Home Assistant Mosquitto HassOS App","text":"<p>If using the default Mosquitto broker, and Customization switched on, check the ACL configuration has <code>readwrite</code> access give to the Updates2MQTT user for its topics. The HomeAssistant add-in config puts this in the <code>/share/mosquitto</code> directory. </p> <p>Oddly, the Paho MQTT client used by Updates2MQTT is known to report success even when broker rejects message because of ACL restrictions.</p>","tags":["docker","docker-compose","homeassistant","mqtt","paho"]},{"location":"troubleshooting/#alternative-mqtt-discovery","title":"Alternative MQTT Discovery","text":"<p>There\u2019s also an alternative to MQTT Discovery in HA, using plain yaml, the MQTT Update Integration. The BBQKees Boiler Gateway has some detailed steps and examples for MQTT Discovery too.</p>","tags":["docker","docker-compose","homeassistant","mqtt","paho"]},{"location":"troubleshooting/#no-update-button","title":"No Update Button","text":"<p>If there\u2019s an update showing, but no Update button present, then there\u2019s a few reasons, which can be checked directly from the config and log:</p> <ul> <li>Config has the <code>allow_pull</code>,<code>allow_restart</code> and <code>allow_build</code> all overridden to <code>False</code></li> <li>A new version reference can\u2019t be found </li> <li>The compose working directory can\u2019t be found</li> <li>This is sourced from the <code>com.docker.compose.project.working_dir</code> label, which can be seen in <code>docker inspect</code></li> <li>This only stops restart, not pull, so if <code>allow_pull</code> is on, the Update button will still show</li> <li>The git repo path can\u2019t be found for a local build</li> </ul> <p>The current state of this can be seen in MQTT, the config message will have two extra values as below:</p> <pre><code>  \"command_topic\": \"updates2mqtt/dockernuc/docker\",\n  \"payload_install\": \"docker|homarr|install\"\n</code></pre>","tags":["docker","docker-compose","homeassistant","mqtt","paho"]},{"location":"troubleshooting/#home-assistant-logs","title":"Home Assistant Logs","text":"<p>Use the System Log to check for MQTT errors, or for positive confirmation that Update entities have been discovered. The raw log will show more, and allow you to scroll back for hours.</p> <p>The Logger Integration lets you tweak the levels of specific integrations. This is less useful for Updates2MQTT, since all the work is happening outside of Home Assistant, however it can be useful for general MQTT issues, and the examples in the Home Assistant documentation shows how to tune the MQTT integration.</p>","tags":["docker","docker-compose","homeassistant","mqtt","paho"]},{"location":"troubleshooting/#docker","title":"Docker","text":"<p>More detailed information on the Docker API and compatibility with Docker engine versions can be found at Docker\u2019s own Docker Engine API reference.</p> <p><code>updates2mqtt</code> is designed to run on the same host as the containers, so only needs local Docker daemon access. All it needs for that is the volume mapping as below:</p> Example Docker Compose Snippet<pre><code>volumes:\n  - /var/run/docker.sock:/var/run/docker.sock\n</code></pre> <p>Where <code>docker-compose</code> projects are being automatically updated and restarted, one problem can be that earlier versions used a <code>docker-compose</code> command and newer ones use <code>docker compose</code>. There is a <code>v1</code> and <code>v2</code> option in the configuration to support this, defaulting to <code>v2</code>.</p> <p>If the <code>updates2mqtt</code> container is not running as root, then ensure that the user is a member of the local <code>docker</code> group. (If it is running as root, then consider moving to a defined user, see Running as Non-Root).</p>","tags":["docker","docker-compose","homeassistant","mqtt","paho"]},{"location":"troubleshooting/#docker-help","title":"Docker Help","text":"<p>Best place to start is the <code>docker-py</code> Issues on GitHub, since this is the primary component inside Updates2MQTT.</p> <p>A simple way of testing if there\u2019s a <code>docker-py</code> issue is to load the client directly from python. This example uses <code>uv</code> to avoid changing local Python environment, use <code>pip</code> or other preferred tool to install if you want instead.</p> <pre><code>uv run --with docker python3\n&gt;&gt;&gt; import docker\n&gt;&gt;&gt; docker.__version__\n&gt;&gt;&gt; client = docker.from_env()\n&gt;&gt;&gt; client.info()['Containers']\n</code></pre> <p>This should output the version of the <code>docker</code> package, and the total count of local containers if the connection is good. Updates2MQTT uses at least v7.1.0 of <code>docker</code> for Python API.</p>","tags":["docker","docker-compose","homeassistant","mqtt","paho"]},{"location":"troubleshooting/#registry-api","title":"Registry API","text":"<p>Updates2MQTT uses the Docker developed <code>docker-py</code> library for local management, and originally for discovering updates. Now by default it uses the more modern OCI v2 Distribution API that <code>docker.io</code> and other registries have supported for years. </p> <p>The <code>api</code> option in Docker<code>registry</code> config can override this, set to <code>docker_client</code>,<code>oci_v2</code> or <code>disabled</code>.</p> <p>The OCI APIs require more network calls, typically one to retrieve a token, one for the image index, which points to the platform specific manifest, and finally the config document. On the other hand, well-developer images also provide  annotations on these documents, which allow for direct links to release notes and source code, descriptions, semantic versions and more.</p> <p>Registries usually have an unauthenticated token system for authorization, this can be overridden per container using the <code>updates2mqtt.registry_token</code> container label or <code>UPD2MQTT_REGISTRY_TOKEN</code> environment variable.</p> <p>If the benefits of the extra calls ( release summaries, direct release note URLs, human friendly version numbers ), then the additional fetches can be skipped by using <code>OCI_V2_MINIMAL</code> as the <code>api</code> value in the registry configuration section.</p> <p>Tip</p> <p>Images built on GitHub often use the <code>docker-metadata</code> action to create the annotations, which is documented at metadata-action</p>","tags":["docker","docker-compose","homeassistant","mqtt","paho"]},{"location":"troubleshooting/#too-many-requests","title":"Too Many Requests","text":"<p>The Docker Registry API has a limit on how many authenticated requests, and a lower limit for unauthenticated requests, can be made per hour.</p> <p>Access to the API will back off when this is hit, and discovery will wait until a configurable period passed, which can be configured using <code>default_api_backoff</code> in the <code>docker</code> configuration section, with a value in seconds.</p> <p>The throttling is determined per registry, so if Docker is throttling it won\u2019t affect <code>gchr.io</code>, private registries or others. They will also throttle if needed, but again the throttle will only affect that specific registry, and other scans will continue.</p> <p>The order of containers scanned is shuffled every time, so if there is a lot of throttling it won\u2019t be the same ones every time.</p>","tags":["docker","docker-compose","homeassistant","mqtt","paho"]},{"location":"troubleshooting/#docker-cli","title":"Docker CLI","text":"<p>There is a very bare bones command line debug tool, that will look up an image in either v1 or v2 APIs and dump everything to console at <code>DEBUG</code> log level, while also retrieving tokens to authorize API access and adapting to Docker Hub, GitHub, GitLab or Codeberg registries.</p> <p>Use the container hash, or a container name if one has been given ( easy to find out either of these with <code>docker ps</code>)</p> <p>There\u2019s no need to install Updates2MQTT to use the manifest and blob fetching ability. </p> <pre><code>uv run --with updates2mqtt cli manifest=ghcr.io/blakeblackshear/frigate:stable\n</code></pre> <p>The following examples will all work from any Python context, and don\u2019t need a local Docker or any Docker access.</p> <pre><code>uv run --with updates2mqtt cli  manifest=ghcr.io/blakeblackshear/frigate:stable\nuv run --with updates2mqtt cli  blob=ghcr.io/blakeblackshear/frigate@sha256:ef8d56a7d50b545af176e950ce328aec7f0b7bc5baebdca189fe661d97924980\nuv run --with updates2mqtt cli  manifest=ghcr.io/blakeblackshear/frigate@sha256:c68fd78fd3237c9ba81b5aa927f17b54f46705990f43b4b5d5596cfbbb626af4\nuv run --with updates2mqtt cli  tags=ghcr.io/blakeblackshear/frigate\nuv run --with updates2mqtt cli  manifest=mcr.microsoft.com/dotnet/sdk:latest\n</code></pre> <p>These examples refer to locally running containers, displaying the local info as well as remote registry</p> <pre><code>uv run --with updates2mqtt cli  container=frigate\nuv run --with updates2mqtt cli container=f4f02e182f5e api=docker_client\nuv run --with updates2mqtt cli container=frigate api=docker_client log_level=DEBUG\n</code></pre> <p>If the package is installed locally then the <code>--with updates2mqtt</code> part can be omitted with uv, or it can be run directly:</p> <pre><code>python updates2mqtt.cli container=frigate api=docker_client\n</code></pre> <p>Get a dump to CSV rather than MQTT of local Docker containers</p> <pre><code>python updates2mqtt.cli dump=csv\n</code></pre>","tags":["docker","docker-compose","homeassistant","mqtt","paho"]},{"location":"configuration/","title":"Configuring Updates2MQTT","text":"<p>Guidance on configuring the main agent for Updates2MQTT, and customizing how individual containers are presented in Home Assistant, or behave on update.</p> <p>{{ pagetree(siblings) }}</p>"},{"location":"configuration/customizing_containers/","title":"Customizing Containers","text":"<p>Each container can be customized, so that when it appears in Home Assistant it has an appropriate logo for its icon, and useful release notes. Some of this is done by pre-loaded metadata, in <code>common_packages.yaml</code>, by API exploration or inference, and some needs to be done locally, especially for more unusual components.</p>"},{"location":"configuration/customizing_containers/#logos-and-release-notes","title":"Logos and Release Notes","text":"<p>Individual docker containers can have customized entity pictures or release notes, using env variables, for example in the <code>docker-compose.yaml</code> or in a separate <code>.env</code> file:</p> docker compose snippet<pre><code>    environment:\n      - UPD2MQTT_PICTURE=https://frigate.video/images/logo.svg\n      - UPD2MQTT_RELNOTES=https://github.com/blakeblackshear/frigate/releases\n</code></pre> <p>or using labels</p> <p>docker compose snippet<pre><code>    labels:\n      updates2mqtt.picture: https://frigate.video/images/logo.svg\n      updates2mqtt.relnotes: https://github.com/blakeblackshear/frigate/releases\n</code></pre>   l The images will show up in the Update section of Settings menu in HomeAssistant, as will the release notes link. SVG icons should be used.</p>"},{"location":"configuration/customizing_containers/#customizing-versions","title":"Customizing Versions","text":"<p>Updates2MQTT attempts to find the most human-friendly representation of image versions that can be reliably used. Ideally that\u2019s a <code>v1.5.4</code> type version (whether formally SemVer or just traditional version).</p> <p>By default, configurable using <code>version_policy</code> in the Docker section of the config, it uses an <code>auto</code> version policy that will choose the most meaningful, and fall back to digests where versions aren\u2019t available (usually via image labels/annotations). This will also take into account where updates are throttled, or a pinned digest declared in the container.</p> <p>This can be overridden at container level using using the <code>updates2mqtt.version_policy</code> container label or <code>UPD2MQTT_VERSION_POLICY</code> environment variable:</p> <ul> <li><code>AUTO</code> - to do the best it can with versions, git repo digests, timestamps, index digests or config digests</li> <li><code>VERSION</code> - always choose simple version unless version not available<ul> <li>Some images use version oddly, where its more of a label applying to multiple releases than a version. Also    there\u2019s guarantee for container images that a human friendly version always points to the same thing.</li> <li>This is useful where you know the image has sensible versions and trust it enough</li> </ul> </li> <li><code>TIMESTAMP</code> - always use the creation timestamp of the image, where its conistent with the digests</li> <li><code>DIGEST</code> - always use the 12-char abbreviated digest, even if version available</li> <li><code>VERSION_DIGEST</code> - use a <code>version:1234567890ab</code> style combo of version and digest id where both available</li> </ul> <p>If the chosen option isn\u2019t available, they\u2019ll all fail back to <code>auto</code>. A diagnostic code, <code>version-select</code> that ties back to precisely which [code])(https://github.com/rhizomatics/updates2mqtt/blob/main/src/updates2mqtt/integrations/docker.py#L533) used is included in the attributes.</p>"},{"location":"configuration/customizing_containers/#silencing-containers","title":"Silencing Containers","text":"<p>If there are containers which are changing very frequently with development builds, or for other reasons shouldn\u2019t be published to Home Assistant, then use the <code>image_ref_select</code> in configuration.</p> <p>They will still be published to MQTT but not to the Home Assistant MQTT Discovery topic.</p> config.yaml snippet<pre><code>docker:\n  enabled: true\n  image_ref_select:\n    exclude:\n      - .*:nightly\n      - .*:dev\n</code></pre> <p>Alternatively, set <code>UPD2MQTT_IGNORE</code> flag on the container itself to completely ignore it.</p>"},{"location":"configuration/customizing_containers/#icon-sources","title":"Icon Sources","text":"<p>Updates look nicer in Home Assistant with a suitable icon. Updates2mqtt comes pre-packaged with some common ones, in <code>common_packages.yaml</code>, and can automatically fetch them (and release links) for the popular linuxserver.io packages.  </p> <p>If you have something not covered, here are some good places to look for self-hosted app icons:</p> <ul> <li>Homarr Dashboard Icons</li> <li>Self Hosted Icons (repo)</li> <li>Simple Icons</li> <li>Tabler Icons</li> <li>Papirus Icons</li> <li>Homelab SVG Assets</li> </ul>"},{"location":"configuration/customizing_containers/#environment-variables","title":"Environment Variables","text":"<p>The following environment variables can be used to configure containers for <code>updates2mqtt</code>:</p> Env Var Description Default <code>UPD2MQTT_UPDATE</code> Update mode, either <code>Passive</code> or <code>Auto</code>. If <code>Auto</code>, updates will be installed automatically. <code>Passive</code> <code>UPD2MQTT_PICTURE</code> URL to an icon to use in Home Assistant. Docker logo URL <code>UPD2MQTT_RELNOTES</code> URL to release notes for the package. <code>UPD2MQTT_GIT_REPO_PATH</code> Relative path to a local git repo if the image is built locally. <code>UPD2MQTT_IGNORE</code> If set to <code>True</code>, the container will be ignored by Updates2MQTT. False <code>UPD2MQTT_VERSION_POLICY</code> Change how version derived from container label or image hash, <code>Version</code>,<code>Digest</code>,<code>Version_Digest</code>,<code>Timestamp</code> with default of <code>Auto</code> <code>UPD2MQTT_REGISTRY_TOKEN</code> Access token for authentication to container distribution API, as alternative to making a call to <code>token</code> service"},{"location":"configuration/customizing_containers/#docker-labels","title":"Docker Labels","text":"<p>Alternatively, use Docker labels</p> Label Env Var <code>updates2mqtt.update</code> <code>UPD2MQTT_UPDATE</code> <code>updates2mqtt.picture</code> <code>UPD2MQTT_PCITURE</code> <code>updates2mqtt.relnotes</code> <code>UPD2MQTT_RELNOTES</code> <code>updates2mqtt.git_repo_path</code> <code>UPD2MQTT_GIT_REPO_PATH</code> <code>updates2mqtt.ignore</code> <code>UPD2MQTT_IGNORE</code> <code>updates2mqtt.version_policy</code> <code>UPD2MQTT_VERSION_POLICY</code> <code>updates2mqtt.registry_token</code> <code>UPD2MQTT_REGISTRY_TOKEN</code> Example Compose Snippet<pre><code>restarter:\n    image: docker:cli\n    command: [\"/bin/sh\", \"-c\", \"while true; do sleep 86400; docker restart mailserver; done\"]\n    labels:\n        updates2mqtt.relnotes: https://component.my.com/release_notes\n</code></pre>"},{"location":"configuration/remote_api_usage/","title":"Remote API Usage","text":"<p>Updates2MQTT uses several remote APIs to check for new versions, or pull in useful metadata, in addition to local API calls to the Docker daemon.</p> <ul> <li>Docker Registry V1 API<ul> <li>These calls are all made via the docker-py Python SDK from the Docker vendor, and now only if the alternative <code>registry_access</code> is selected</li> </ul> </li> <li>OCI Container Distribution V2 API<ul> <li>This API is supported all mainstream container registries, and provides indexes ( which can be accessed by digest, or by a tag like <code>latest</code> or <code>nightly</code>, and are the mechanism by which new versions are discovered), plus manifests and config documents which provide more detail including annotations and labels</li> </ul> </li> <li>GitHub REST API<ul> <li>Used to pull in release summaries where container images provide source links and revisions</li> </ul> </li> <li>LinuxServer API<ul> <li>Used to get release notes and icons for lots of popular containers</li> </ul> </li> </ul>"},{"location":"configuration/remote_api_usage/#api-throttling","title":"API Throttling","text":""},{"location":"configuration/remote_api_usage/#container-registry-apis","title":"Container Registry APIs","text":"<p>Docker API has usage limits which may be triggered if there are many containers ( and other registries will have similar).</p> <p><code>updates2mqtt</code> will back off if a <code>429</code> Too Many Requests response is received, and pause for that specific registry for the requested number of seconds. There\u2019s a default in <code>docker</code> config of <code>default_api_backoff</code> applied if the backoff can\u2019t be automatically determined.</p> <p>The main technique to avoid throttling is caching of responses, and fortunately many of the calls are cache friendly, such as the manifest retrieval. By default, responses will be cached as suggested by the registry API service (explanation), however this can be overridden with these options:</p> Config Key Default Comments <code>mutable_cache_ttl</code> None This is primarily the fetch of <code>latest</code> or similar tags to get new versions <code>immutable_cache_ttl</code> 7776000 (90 days) This is for anything fetched by a digest, such as image manifests. The only limitation for these should be storage space <code>token_cache_ttl</code> None Caching for authorization tokens, <code>docker.io</code> is good for 300 seconds, not all registries publish the life in the response <p>The cache, using Hishel, is automatically cleaned up of old entries once the TTL (Time to Live) has expired.</p> <p>The other approach can be to reduce the scan interval, or ignore some of the containers.</p>"},{"location":"configuration/remote_api_usage/#github-api","title":"GitHub API","text":"<p>GitHub REST API has its own throttling, which may impact fetching release summaries. A higher limit can be achieved using a personal access token. Create one in Developer Settings in GitHub, make sure it has access to \u201cPublic Repositories\u201d, and configure it in Updates2MQTT as below:</p> updates2mqtt config snippet<pre><code>github:\n  access_token: my_access_token\n</code></pre>"},{"location":"configuration/security/","title":"Improving Security","text":""},{"location":"configuration/security/#moving-secrets-out-of-config","title":"Moving Secrets Out of Config","text":"<p>Example use of environment variables, e.g. for secrets:</p> config.yaml snippet<pre><code>mqtt:\n    password: ${oc.env:MQTT_PASS}\n</code></pre>"},{"location":"configuration/security/#running-as-non-root","title":"Running as non-root","text":"<p>It is good practice not to run Docker containers as root, and <code>updates2mqtt</code> will work with any user so long as it has Docker permissions, usually as a result of being a member of the <code>docker</code> group.</p> <p>To create a suitable use, use the shell command below - it will create a user that can only be used for this purpose, and can\u2019t otherwise login. It assumes there is already a group called <code>docker</code> with access to the Docker Daemon, if you dont have one, follow the Docker Post Install Steps which explain how and why to do it.</p> <pre><code>sudo adduser --system --ingroup docker --no-create-home -shell /sbin/nologin updates2mqtt\n</code></pre> <p>Note the <code>uid</code> that is reported here. If you don\u2019t know the <code>gid</code> for the <code>docker</code> group, use <code>grep docker /etc/group</code>. In this example, our <code>uid</code> is <code>130</code> and the <code>gid</code> of <code>docker</code> group is <code>119</code>.</p> <p>In the <code>docker-compose.yaml</code>, set the user and group using user attribute:</p> docker compose snippet<pre><code>services:\n  updates2mqtt:\n    container_name: updates2mqtt\n    image: ghcr.io/rhizomatics/updates2mqtt:latest\n    user: 130:119\n</code></pre> <p>If you\u2019re using Updates2MQTT to update local git repos, then the user created above will also need <code>rw</code> access to those, which you can do by making it a member of the same group as owns the repos and making sure they have group <code>rw</code> access configured.</p> <p>For more information, see the Understanding the Docker USER Instruction article from Docker.</p>"},{"location":"configuration/security/#mqtt-access-control","title":"MQTT Access Control","text":"<p>Its best to have a dedicated MQTT user for Updates2MQTT, for security and debug. For most secure installations, only use secure ports with validated certificates, although this will require more complicated setup and ongoing support, including using host names rather than IP addresses, and with LetsEncrypt to update certificates.</p> <p>The two brokers most commonly used with Home Assistant, Mosquitto and EMQX, both have access control mechanisms, so you can restrict the user account for Updates2MQTT to only be able to read and write its own topics.</p>"},{"location":"configuration/using_a_config_file/","title":"Using A Configuration File","text":"<p>The configuration file is optional, and only needed if you have to override the defaults. See Without a Config File for the alternatives.</p> <p>Create file <code>config.yaml</code> in <code>conf</code> directory. If the file is not present, a default file will be generated, and the parent director if necessary. If you don\u2019t want that to happen, then set <code>U2M_AUTOGEN_CONFIG=0</code>.</p>"},{"location":"configuration/using_a_config_file/#example-configuration-file","title":"Example configuration file","text":"<p>This is a maximal config file, the minimum is no config file at all, which will generate a default config file. The only mandatory values are the MQTT user name and password, everything else can be omitted ( although its best to have at least a <code>node</code> <code>name</code> value so HomeAssistant doesn\u2019t show some ugly generated Docker host name).</p> config.yaml snippet<pre><code>node:\n  name: docker-host-1 # Unique name for this instance, used to name MQTT entities. Defaults to O/S hostname\n  git_repo_path: /usr/bin/git # Path to git inside container, needed only if non-default and using local docker builds\n  healthcheck:\n    enabled: true\n    interval: 300 # publish a heartbeat every 5 minutes\n    topic_template: healthcheck/{node_name}/updates2mqtt\nmqtt:\n  host: ${oc.env:MQTT_HOST}\n  user: ${oc.env:MQTT_USER}\n  password: ${oc.env:MQTT_PASS}$ # Use an environment variable for secrets\n  port: ${oc.env:MQTT_PORT}\n  topic_root: updates2mqtt\n  protocol: 3.11 # Can be changed to 5 if your broker supports it\nhomeassistant:\n  discovery:\n    prefix: homeassistant # Matches the default MQTT discovery prefix in Home Assistant\n    enabled: true\n  state_topic_suffix: state\n  device_creation: true # create a Home Assistant device and associate it with each update entity\n  area: \"Server Room\" # suggest an area for Home Assistant to give to the Device\n  extra_attributes: true # use `json_attributes_topic` feature in Home Assistant to source state attributes from discover\n  force_command_creation: # create a command topic even if there's no support for automated update\ndocker:\n  enabled: true\n  allow_pull: true # if true, will do a `docker pull` if an update is available\n  allow_restart: true # if true, will do a `docker-compose up` if an update is installed\n  allow_build: true # if true, will do a `docker-compose build` if a git repo is configured\n  compose_version: v2 # Controls whether to use `docker-compose` (v1) or `docker compose` (v2) command\n  default_entity_picture_url: https://www.docker.com/wp-content/uploads/2022/03/Moby-logo.png # Picture for update dialog\n  device_icon: mdi:docker # Material Design Icon to use when browsing entities in Home Assistant\n  default_api_backoff: 600 # Default time to back off container registry APIs\n  # device_icon: mdi:train-car-container # Alternative icon if you don't like Docker branding\n  discover_metadata:\n    linuxserver.io:\n      enabled: true\n      cache_ttl: 604800 # cache metadata for 1 week\n  image_ref_select: # limit the containers which will be published to Home Assistant\n    include:\n    - .*special-dev\n    exclude:\n    - .*dev\n    - .*nightly\n  version_select:  # limit the containers which will be published to Home Assistant\n     exclude:\n     -  .*-beta.*\n     include: \n     - 1\\..*\nscan_interval: 10800 # sleep interval between scan runs, in seconds\nlog:\n  level: INFO\n</code></pre>"},{"location":"configuration/zero_config_file/","title":"Without a Configuration File","text":"<p>The core configuration can be supplied by environment variables and container labels, everything else will default, either to fixed values built into Updates2MQTT, or in the case of the node name, taken from the operating system.</p> Env Var Default MQTT_HOST localhost MQTT_PORT 1883 MQTT_USER NO DEFAULT MQTT_PASSWORD NO DEFAULT MQTT_VERSION 3.11. U2M_LOG_LEVEL INFO <p>Startup will fail if <code>MQTT_USER</code> and <code>MQTT_PASSWORD</code> are not defined some how.</p> <p>The example docker-compose.yaml and .env demonstrate one way of doing this, or skip the <code>.env</code> file and use an <code>environment</code> section in the Compose file.</p> <p>Set <code>U2M_AUTOGEN_CONFIG=0</code> in the environment to prevent a default config file being created in the local compose directory if you want to keep it zero-configuration-file.</p>"},{"location":"configuration/examples/","title":"Example Configurations","text":"<p>Configuration files and Docker Compose files.</p> <p>{{ pagetree(siblings) }}</p>"},{"location":"configuration/examples/config_maximal/","title":"Maximal Configuration","text":"<p>More extensive example configuration, using all the features</p> <pre><code>log:\n  level: INFO\nnode:\n  name: mydockerpc\n  git_path: /usr/bin/git\n  healthcheck:\n    enabled: true\n    interval: 300\n    topic_template: healthcheck/{node_name}/updates2mqtt\nmqtt:\n  host: localhost\n  port: 1883\n  user: mymqttuser\n  password: mysecret\n  topic_root: updates2mqtt\n  protocol: 5\nhomeassistant:\n  discovery:\n    prefix: homeassistant\n    enabled: true\n  state_topic_suffix: state\n  area: Server Room\n  device_creation: true\n  force_command_topic: false\n  extra_attributes: true\ndocker:\n  enabled: true\n  allow_pull: true\n  allow_restart: true\n  allow_build: true\n  compose_version: v2\n  default_entity_picture_url: https://www.docker.com/wp-content/uploads/2022/03/Moby-logo.png\n  device_icon: mdi:docker\n  default_api_backoff: 1800\n  version_policy: VERSION_DIGEST\n  discover_metadata:\n    linuxserver.io:\n      enabled: true\n      cache_ttl: 604800\n  image_ref_select:\n    include:\n    - .*special-dev\n    exclude:\n    - .*dev\n    - .*nightly\n  version_select:\n     exclude: \n     - .*-beta.*\n     include:\n     -  1\\..*\n  registry:\n    immutable_cache_ttl: 2592000\n    api: OCI_V2\nscan_interval: 10800\ngithub:\n  access_token: github_pat_00001111444445555666677778888\npackages:\n  my_custom_pkg:\n    docker:\n      image_name: ghcr.io/dummy/my_custom\n      version_policy: DIGEST\n    logo_url: https://avatars.githubusercontent.com/u/162821199?s=48&amp;v=4\n    source_repo_url: https://github.com/dummy/my_custom\n    release_notes_url:  https://github.com/dummy/my_custom/releases\n</code></pre>"},{"location":"configuration/examples/config_minimal/","title":"Minimal Configuration","text":"<p>Smallest working configuration ( although the actual smallest is no file at all and using only environment variables for MQTT )</p> <pre><code>mqtt:\n  host: ${oc.env:MQTT_HOST,\"127.0.0.1\"}\n  port: ${oc.env:MQTT_PORT,1883}\n  user: ${oc.env:MQTT_USER}\n  password: ${oc.env:MQTT_PASS}\n\nnode:\n  name: dockernuc\n</code></pre>"},{"location":"configuration/examples/docker_compose/","title":"Docker Compose","text":"<p>Example Docker Compose configuration to run Updates2MQTT as a container. This also requires a .env, or alternatively adding the environment variables directly into the compose file.</p> <pre><code>services:\n  updates2mqtt:\n    container_name: updates2mqtt\n    image: ghcr.io/rhizomatics/updates2mqtt:release\n    volumes:\n      - ./conf:/app/conf  # Config file lives at /app/conf/config.yaml inside the container\n      # - ./cache:/app/.cache. # Optionally move cache out of container so it survives container down/up\n      - /var/run/docker.sock:/var/run/docker.sock # Access to Docker daemon for container updates\n      - /my/container/home:/my/container/home # Optional, map all root paths for docker compose directories\n    restart: always\n    env_file: ./.env  # Environment variables file\n    healthcheck:\n      test: [\"CMD\", \"/app/healthcheck.sh\",\"healthcheck/MYNODENAME/updates2mqtt\"] # Change for your node name\n      interval: 5m\n      timeout: 30s\n      retries: 3\n      start_period: 60s\n</code></pre>"},{"location":"configuration/examples/env/","title":"Environment File","text":"<p>Example <code>.env</code> file for Docker Compose configuration to separately store the environment variables.</p> <pre><code># Example env file for docker-compose.yaml\n# Used by both the app itself and the healthcheck script\n\n# To use these, add to config.yaml like ${oc.env:MQTT_HOST}\n\nMQTT_HOST=192.168.0.1\nMQTT_PORT=1883\nMQTT_USER=my_mqtt_user\nMQTT_PASS=my_mqtt_secret\n</code></pre>"},{"location":"developer/oci_container/","title":"Understanding Container Metadata","text":""},{"location":"developer/oci_container/#key-entities","title":"Key Entities","text":"<p>Documented at the OCI Image Format Specification</p> <p><pre><code>---\nconfig:\n    class:\n      hideEmptyMembersBox: true\n---\nclassDiagram\n    class ImageIndex {\n        +ManifestDescriptor[] manifestDescriptors\n        +Annotations annotations\n    }\n    link ImageIndex \"https://github.com/opencontainers/image-spec/blob/main/image-index.md\" \"OCI Specification\"\n    note for ImageIndex \"Catalogs manifests\\n for each architecture\\n and operating systems\"\n    class ImageManifest {\n        +Descriptor config\n        +Descriptor[] layers\n        +Annotations annotations\n    }\n    link ImageManifest \"https://github.com/opencontainers/image-spec/blob/main/manifest.md\" \"OCI Specification\"\n    note for ImageManifest \"Lists layers and\\n their digests,\\n and points to the config doc\"\n    class ImageConfig {\n        +string created\n        +string author\n        +string architecture\n        +string os\n        +Config config\n        +RootFS rootfs\n        +History[] history\n    }\n    link ImageConfig \"https://github.com/opencontainers/image-spec/blob/main/config.md\" \"OCI Specification\"\n    note for ImageConfig \"Everything specified\\n by the Dockerfile,\\n and history to\\n record building of each step\"\n\n    ImageIndex \"1\" --&gt; \"*\" ImageManifest : refers\n    ImageManifest \"1\" --&gt; \"1\" ImageConfig : refers\n    ImageManifest \"1\" --&gt; \"*\" Layers : refers\n\n\n</code></pre> <pre><code>\n</code></pre> <pre><code>\n</code></pre> <pre><code>\n</code></pre> <pre><code>\n</code></pre> <pre><code>\n</code></pre> <pre><code>\n</code></pre> <pre><code>\n</code></pre> <pre><code>\n</code></pre> <pre><code>\n</code></pre> <pre><code>\n</code></pre> <pre><code>\n</code></pre> <pre><code>\n</code></pre> <pre><code>\n</code></pre> <pre><code>\n</code></pre> <pre><code>\n</code></pre> <pre><code>\n</code></pre> <pre><code>\n</code></pre> <pre><code>\n</code></pre> ```</p>"},{"location":"developer/coverage/","title":"Coverage","text":""}]}